<app-auth-card title="Réinitialisation du mot de passe" subtitle="Saisissez le code reçu par email">
  <form [formGroup]="resetForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Étape 1 : Vérification OTP -->
    <div class="border-b pb-4 mb-4">
      <div class="mb-2 text-base font-semibold text-primary-700">1. Vérifiez le code OTP</div>
      <label for="email" class="block text-sm font-medium mb-2">Email</label>
      <input id="email" type="email" formControlName="email" class="w-full px-4 py-2 border rounded-lg"
        [readonly]="true" />
      <app-form-field-error [control]="emailControl"></app-form-field-error>
      <label for="otpCode" class="block text-sm font-medium mt-4 mb-2">Code reçu par email</label>
      <div class="flex gap-2">
        <input id="otpCode" type="text" maxlength="6" formControlName="otpCode"
          class="w-full px-4 py-2 border rounded-lg" [readonly]="otpStatus === 'valid'" />
        <button type="button" (click)="onVerifyOtp()"
          [disabled]="otpCode?.invalid || isLoading || otpStatus === 'valid'"
          class="px-4 py-2 bg-primary-500 text-white rounded-lg flex items-center justify-center cursor-pointer disabled:cursor-not-allowed">
          @if (!isLoading) {
          <span>Vérifier</span>
          }
          @if (isLoading) {
          <span class="loader ml-2"></span>
          }
        </button>
      </div>
      <app-form-field-error [control]="otpCode"></app-form-field-error>
      @if (otpStatus !== 'pending') {
      <div [ngClass]="{
          'text-green-600': otpStatus === 'valid',
          'text-red-600': otpStatus === 'invalid' || otpStatus === 'expired'
        }" class="text-sm mt-1 font-semibold">{{ otpMessage }}</div>
      }
    </div>

    <!-- Étape 2 : Saisie du nouveau mot de passe -->
    <div class="opacity-100 transition-opacity duration-300" [class.opacity-50]="otpStatus !== 'valid'">
      <div class="mb-2 text-base font-semibold text-primary-700">2. Saisissez le nouveau mot de passe</div>
      <label for="newPassword" class="block text-sm font-medium mb-2">Nouveau mot de passe</label>
      <input id="newPassword" type="password" formControlName="newPassword"
        class="w-full px-4 py-2 border rounded-lg" />
      <app-form-field-error [control]="newPassword"></app-form-field-error>
      <label for="confirmPassword" class="block text-sm font-medium mb-2 mt-4">Confirmer le mot de passe</label>
      <input id="confirmPassword" type="password" formControlName="confirmPassword"
        class="w-full px-4 py-2 border rounded-lg" />
      <app-form-field-error [control]="confirmPassword"></app-form-field-error>
      @if (resetForm.hasError('passwordMismatch') && confirmPassword?.touched) {
      <div class="text-sm text-red-600">
        Les mots de passe ne correspondent pas
      </div>
      }
    </div>

    <button type="submit" [disabled]="resetForm.invalid || isLoading || otpStatus !== 'valid'"
      class="w-full py-2 bg-primary-600 text-white rounded-lg flex items-center justify-center mt-4 cursor-pointer disabled:cursor-not-allowed">
      @if (!isLoading) {
      <span>Réinitialiser le mot de passe</span>
      }
      @if (isLoading) {
      <span class="loader ml-2"></span>
      }
    </button>
  </form>

  <div class="text-center mt-4">
    <a routerLink="/auth/login" class="text-sm text-indigo-600 hover:underline">Retour à la connexion</a>
  </div>
</app-auth-card>